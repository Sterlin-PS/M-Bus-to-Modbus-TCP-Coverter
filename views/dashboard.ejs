<!DOCTYPE html>
<html>
<head>
  <title>M-Bus to Modbus Converter</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #1a1a2e; color: #eee; padding: 20px; }
    h1 { margin-bottom: 20px; color: #0f0; }
    h2 { color: #e94560; margin: 15px 0 10px; font-size: 16px; }
    .container { max-width: 1400px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); gap: 20px; }
    .card { background: #16213e; border-radius: 8px; padding: 15px; border: 1px solid #0f3460; }
    .card h3 { color: #e94560; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .status { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; }
    .status.running { background: #0f0; color: #000; }
    .status.stopped { background: #666; }
    .status.error { background: #e94560; }
    .info { font-size: 13px; color: #aaa; margin: 5px 0; }
    .port { font-size: 20px; color: #0f0; font-weight: bold; }
    .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin: 2px; font-size: 12px; }
    .btn-start { background: #0f0; color: #000; }
    .btn-stop { background: #e94560; color: #fff; }
    .btn-delete { background: #333; color: #fff; }
    .btn-sm { padding: 4px 8px; font-size: 11px; }
    .add-form { background: #16213e; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #0f3460; }
    .form-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: end; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-size: 11px; color: #aaa; margin-bottom: 3px; }
    .form-group input, .form-group select { padding: 6px; border: 1px solid #0f3460; background: #0a0a15; color: #fff; border-radius: 4px; font-size: 12px; }
    .hidden { display: none; }
    .device-list { margin-top: 10px; }
    .device-item { background: #0a0a15; padding: 10px; border-radius: 4px; margin: 5px 0; }
    .device-header { display: flex; justify-content: space-between; align-items: center; }
    .unit-badge { background: #0f3460; padding: 2px 8px; border-radius: 3px; font-size: 12px; color: #0f0; }
    .mapping-table { width: 100%; margin-top: 8px; font-size: 11px; border-collapse: collapse; }
    .mapping-table th, .mapping-table td { padding: 4px; text-align: left; border-bottom: 1px solid #0f3460; }
    .mapping-table th { color: #aaa; }
    .value { color: #0f0; }
    .registers-preview { background: #0a0a15; padding: 8px; margin-top: 5px; border-radius: 4px; font-family: monospace; font-size: 10px; max-height: 80px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>M-Bus to Modbus TCP Converter</h1>

    <!-- Add Loop Form -->
    <div class="add-form">
      <h2>Add New Loop (M-Bus Connection)</h2>
      <form id="addLoopForm">
        <div class="form-row">
          <div class="form-group">
            <label>Loop ID</label>
            <input type="number" name="id" required style="width:60px">
          </div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" name="name" placeholder="Heat Meters" style="width:120px">
          </div>
          <div class="form-group">
            <label>M-Bus Type</label>
            <select name="mbusType" id="mbusType">
              <option value="serial">Serial</option>
              <option value="tcp">TCP</option>
            </select>
          </div>
          <div class="form-group serial-fields">
            <label>Serial Path</label>
            <input type="text" name="mbusPath" value="/dev/ttyUSB0" style="width:110px">
          </div>
          <div class="form-group serial-fields">
            <label>Baud</label>
            <input type="number" name="baudRate" value="2400" style="width:70px">
          </div>
          <div class="form-group tcp-fields hidden">
            <label>Host</label>
            <input type="text" name="mbusHost" placeholder="192.168.1.100" style="width:120px">
          </div>
          <div class="form-group tcp-fields hidden">
            <label>Port</label>
            <input type="number" name="mbusPort" value="10001" style="width:70px">
          </div>
          <div class="form-group">
            <label>Modbus Port</label>
            <input type="number" name="modbusPort" value="5021" required style="width:70px">
          </div>
          <div class="form-group">
            <label>Poll (ms)</label>
            <input type="number" name="pollInterval" value="60000" style="width:70px">
          </div>
          <button type="submit" class="btn btn-start">Create Loop</button>
        </div>
      </form>
    </div>

    <!-- Loops Grid -->
    <div class="grid">
      <% if (loops.length === 0) { %>
        <div class="card"><p style="color:#666">No loops configured. Create one above.</p></div>
      <% } %>

      <% loops.forEach(loop => { %>
        <div class="card" data-loop-id="<%= loop.id %>">
          <h3>
            <span><%= loop.name || 'Loop ' + loop.id %> <span class="status <%= loop.status %>"><%= loop.status %></span></span>
            <span class="port">:<%= loop.modbusPort %></span>
          </h3>

          <div class="info">M-Bus: <%= loop.mbusType?.toUpperCase() || 'SERIAL' %> - <%= loop.mbusConnection %></div>
          <div class="info">Poll: <%= loop.pollInterval / 1000 %>s | Last: <%= loop.lastPoll ? new Date(loop.lastPoll).toLocaleTimeString() : 'Never' %></div>
          <% if (loop.lastError) { %><div class="info" style="color:#e94560">Error: <%= loop.lastError %></div><% } %>

          <div style="margin: 10px 0;">
            <% if (loop.status !== 'running') { %>
              <button class="btn btn-start" onclick="startLoop(<%= loop.id %>)">Start</button>
            <% } else { %>
              <button class="btn btn-stop" onclick="stopLoop(<%= loop.id %>)">Stop</button>
            <% } %>
            <button class="btn btn-delete" onclick="deleteLoop(<%= loop.id %>)">Delete</button>
            <button class="btn" style="background:#0f3460" onclick="testRead(<%= loop.id %>)">Test Read</button>
          </div>

          <h2>Devices (M-Bus → Modbus Unit)</h2>
          <div class="device-list">
            <% if (!loop.devices || loop.devices.length === 0) { %>
              <div class="info">No devices. Add one below.</div>
            <% } %>

            <% (loop.devices || []).forEach((device, idx) => { %>
              <div class="device-item">
                <div class="device-header">
                  <span>
                    <strong><%= device.name || 'Device ' + (idx+1) %></strong>
                    <span style="color:#aaa;margin-left:10px">M-Bus: <%= device.mbus_address %></span>
                  </span>
                  <span>
                    <span class="unit-badge">Unit <%= device.modbus_unit_id %></span>
                    <button class="btn btn-delete btn-sm" onclick="deleteDevice(<%= device.id %>)">×</button>
                  </span>
                </div>

                <% const unitRegs = loop.registers?.[device.modbus_unit_id]; %>
                <% if (unitRegs && unitRegs.some(r => r !== 0)) { %>
                  <div class="registers-preview">
                    Reg 0-19: [<%= unitRegs.slice(0, 20).join(', ') %>]
                  </div>
                <% } %>

                <% const devData = loop.deviceData?.[device.id]; %>
                <% if (devData && devData.records) { %>
                  <table class="mapping-table">
                    <tr><th>Rec#</th><th>Value</th><th>Unit</th><th>→ Reg</th></tr>
                    <% devData.records.slice(0, 8).forEach((rec, i) => { %>
                      <tr>
                        <td><%= i %></td>
                        <td class="value"><%= typeof rec.value === 'number' ? rec.value.toFixed(2) : rec.value %></td>
                        <td><%= rec.unit %></td>
                        <td><%= i * 2 %>-<%= i * 2 + 1 %></td>
                      </tr>
                    <% }); %>
                    <% if (devData.records.length > 8) { %><tr><td colspan="4" style="color:#666">...and <%= devData.records.length - 8 %> more</td></tr><% } %>
                  </table>
                <% } %>
              </div>
            <% }); %>

            <!-- Add Device Form -->
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #0f3460;">
              <div class="form-row">
                <div class="form-group">
                  <label>Device Name</label>
                  <input type="text" id="devName-<%= loop.id %>" placeholder="Heat Meter 1" style="width:100px">
                </div>
                <div class="form-group">
                  <label>M-Bus Addr</label>
                  <input type="text" id="devAddr-<%= loop.id %>" placeholder="25 or 66786758" style="width:90px">
                </div>
                <div class="form-group">
                  <label>Modbus Unit</label>
                  <input type="number" id="devUnit-<%= loop.id %>" value="<%= (loop.devices?.length || 0) + 1 %>" style="width:60px">
                </div>
                <button class="btn btn-start btn-sm" onclick="addDevice(<%= loop.id %>)">+ Add Device</button>
              </div>
            </div>
          </div>
        </div>
      <% }); %>
    </div>
  </div>

  <script>
    // Toggle serial/tcp fields
    document.getElementById('mbusType').addEventListener('change', function() {
      const isSerial = this.value === 'serial';
      document.querySelectorAll('.serial-fields').forEach(el => el.classList.toggle('hidden', !isSerial));
      document.querySelectorAll('.tcp-fields').forEach(el => el.classList.toggle('hidden', isSerial));
    });

    // Add loop
    document.getElementById('addLoopForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(this));
      const res = await fetch('/api/loops', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await res.json();
      if (result.success) location.reload();
      else alert('Error: ' + result.error);
    });

    async function startLoop(id) {
      await fetch(`/api/loops/${id}/start`, { method: 'POST' });
      location.reload();
    }

    async function stopLoop(id) {
      await fetch(`/api/loops/${id}/stop`, { method: 'POST' });
      location.reload();
    }

    async function deleteLoop(id) {
      if (confirm('Delete this loop and all its devices?')) {
        await fetch(`/api/loops/${id}`, { method: 'DELETE' });
        location.reload();
      }
    }

    async function addDevice(loopId) {
      const name = document.getElementById(`devName-${loopId}`).value;
      const mbusAddress = document.getElementById(`devAddr-${loopId}`).value;
      const modbusUnitId = document.getElementById(`devUnit-${loopId}`).value;

      if (!mbusAddress) return alert('M-Bus address required');

      await fetch(`/api/loops/${loopId}/devices`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, mbusAddress, modbusUnitId })
      });
      location.reload();
    }

    async function deleteDevice(deviceId) {
      if (confirm('Delete this device?')) {
        await fetch(`/api/devices/${deviceId}`, { method: 'DELETE' });
        location.reload();
      }
    }

    async function testRead(loopId) {
      const address = prompt('M-Bus address to test:\n- Primary: 1-250\n- Secondary: 8-digit ID', '25');
      if (!address) return;

      const res = await fetch(`/api/loops/${loopId}/read`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ address })
      });
      const data = await res.json();

      if (data.error) {
        alert('Error: ' + data.error);
      } else if (data.records) {
        let msg = `Meter: ${data.manufacturer} (${data.medium})\nID: ${data.id}\n\nRecords:\n`;
        data.records.slice(0, 10).forEach((r, i) => {
          msg += `${i}: ${r.value} ${r.unit}\n`;
        });
        if (data.records.length > 10) msg += `...and ${data.records.length - 10} more`;
        alert(msg);
      }
    }
  </script>
</body>
</html>
