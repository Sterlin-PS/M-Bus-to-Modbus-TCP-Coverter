<!DOCTYPE html>
<html>
<head>
  <title>M-Bus to Modbus Converter</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #1a1a2e; color: #eee; padding: 20px; }
    h1 { margin-bottom: 20px; color: #0f0; }
    .container { max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    .card { background: #16213e; border-radius: 8px; padding: 15px; border: 1px solid #0f3460; }
    .card h3 { color: #e94560; margin-bottom: 10px; }
    .status { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; }
    .status.running { background: #0f0; color: #000; }
    .status.stopped { background: #666; }
    .status.error { background: #e94560; }
    .info { font-size: 13px; color: #aaa; margin: 5px 0; }
    .port { font-size: 24px; color: #0f0; font-weight: bold; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 2px; }
    .btn-start { background: #0f0; color: #000; }
    .btn-stop { background: #e94560; color: #fff; }
    .btn-delete { background: #333; color: #fff; }
    .btn-read { background: #0f3460; color: #fff; }
    .registers { background: #0a0a15; padding: 10px; margin-top: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 100px; overflow-y: auto; }
    .add-form { background: #16213e; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #0f3460; }
    .add-form h3 { margin-bottom: 15px; }
    .form-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: end; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-size: 12px; color: #aaa; margin-bottom: 4px; }
    .form-group input, .form-group select { padding: 8px; border: 1px solid #0f3460; background: #0a0a15; color: #fff; border-radius: 4px; }
    .hidden { display: none; }
    .read-result { background: #0a0a15; padding: 10px; margin-top: 10px; border-radius: 4px; font-family: monospace; font-size: 11px; white-space: pre-wrap; word-break: break-all; }
  </style>
</head>
<body>
  <div class="container">
    <h1>M-Bus to Modbus TCP Converter</h1>

    <div class="add-form">
      <h3>Add New Loop</h3>
      <form id="addForm">
        <div class="form-row">
          <div class="form-group">
            <label>Loop ID</label>
            <input type="number" name="id" required style="width:80px">
          </div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" name="name" placeholder="Loop 1" style="width:120px">
          </div>
          <div class="form-group">
            <label>M-Bus Type</label>
            <select name="mbusType" id="mbusType">
              <option value="tcp">TCP</option>
              <option value="serial">Serial</option>
            </select>
          </div>
          <div class="form-group tcp-fields">
            <label>M-Bus Host</label>
            <input type="text" name="mbusHost" placeholder="192.168.1.100" style="width:130px">
          </div>
          <div class="form-group tcp-fields">
            <label>M-Bus Port</label>
            <input type="number" name="mbusPort" value="10001" style="width:80px">
          </div>
          <div class="form-group serial-fields hidden">
            <label>Serial Path</label>
            <input type="text" name="mbusPath" placeholder="/dev/ttyUSB0" style="width:120px">
          </div>
          <div class="form-group serial-fields hidden">
            <label>Baud Rate</label>
            <input type="number" name="baudeRate" value="2400" style="width:80px">
          </div>
          <div class="form-group">
            <label>Modbus TCP Port</label>
            <input type="number" name="modbusPort" value="5021" required style="width:80px">
          </div>
          <div class="form-group">
            <label>Poll (ms)</label>
            <input type="number" name="pollInterval" value="60000" style="width:80px">
          </div>
          <button type="submit" class="btn btn-start">Add Loop</button>
        </div>
      </form>
    </div>

    <div class="grid" id="loopsGrid">
      <% if (loops.length === 0) { %>
        <div class="card">
          <p style="color:#666">No loops configured. Add one above.</p>
        </div>
      <% } %>
      <% loops.forEach(loop => { %>
        <div class="card" data-id="<%= loop.id %>">
          <h3><%= loop.name %> <span class="status <%= loop.status %>"><%= loop.status %></span></h3>
          <div class="port">:<%= loop.modbusPort %></div>
          <div class="info">M-Bus: <%= loop.mbusType.toUpperCase() %> - <%= loop.mbusConnection %></div>
          <div class="info">Last Poll: <%= loop.lastPoll ? new Date(loop.lastPoll).toLocaleString() : 'Never' %></div>
          <% if (loop.lastError) { %>
            <div class="info" style="color:#e94560">Error: <%= loop.lastError %></div>
          <% } %>
          <div style="margin-top:10px">
            <% if (loop.status !== 'running') { %>
              <button class="btn btn-start" onclick="startLoop(<%= loop.id %>)">Start</button>
            <% } else { %>
              <button class="btn btn-stop" onclick="stopLoop(<%= loop.id %>)">Stop</button>
            <% } %>
            <button class="btn btn-delete" onclick="deleteLoop(<%= loop.id %>)">Delete</button>
            <button class="btn btn-read" onclick="testRead(<%= loop.id %>)">Test Read</button>
          </div>
          <div class="registers">
            Registers: [<%= loop.registers.slice(0,10).join(', ') %>...]
          </div>
          <div class="read-result" id="result-<%= loop.id %>" style="display:none"></div>
        </div>
      <% }) %>
    </div>
  </div>

  <script>
    // Toggle serial/tcp fields
    document.getElementById('mbusType').addEventListener('change', function() {
      const isTcp = this.value === 'tcp';
      document.querySelectorAll('.tcp-fields').forEach(el => el.classList.toggle('hidden', !isTcp));
      document.querySelectorAll('.serial-fields').forEach(el => el.classList.toggle('hidden', isTcp));
    });

    // Add loop form
    document.getElementById('addForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(this));
      await fetch('/api/loops', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      location.reload();
    });

    async function startLoop(id) {
      await fetch(`/api/loops/${id}/start`, { method: 'POST' });
      location.reload();
    }

    async function stopLoop(id) {
      await fetch(`/api/loops/${id}/stop`, { method: 'POST' });
      location.reload();
    }

    async function deleteLoop(id) {
      if (confirm('Delete this loop?')) {
        await fetch(`/api/loops/${id}`, { method: 'DELETE' });
        location.reload();
      }
    }

    async function testRead(id) {
      const address = prompt('M-Bus device address (1-250):', '1');
      if (!address) return;
      const res = await fetch(`/api/loops/${id}/read`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ address })
      });
      const data = await res.json();
      const el = document.getElementById(`result-${id}`);
      el.style.display = 'block';
      el.textContent = JSON.stringify(data, null, 2);
    }

    // Auto-refresh status every 5 seconds
    setInterval(async () => {
      const res = await fetch('/api/loops');
      const loops = await res.json();
      // Update status without full reload
      loops.forEach(loop => {
        const card = document.querySelector(`.card[data-id="${loop.id}"]`);
        if (card) {
          const status = card.querySelector('.status');
          status.className = `status ${loop.status}`;
          status.textContent = loop.status;
        }
      });
    }, 5000);
  </script>
</body>
</html>
