<!DOCTYPE html>
<html>
<head>
  <title>M-Bus to Modbus Converter</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #1a1a2e; color: #eee; padding: 20px; }
    h1 { margin-bottom: 20px; color: #0f0; }
    .container { max-width: 1400px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
    .card { background: #16213e; border-radius: 8px; padding: 15px; border: 1px solid #0f3460; }
    .card h3 { color: #e94560; margin-bottom: 10px; }
    .status { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; }
    .status.running { background: #0f0; color: #000; }
    .status.stopped { background: #666; }
    .status.error { background: #e94560; }
    .info { font-size: 13px; color: #aaa; margin: 5px 0; }
    .port { font-size: 24px; color: #0f0; font-weight: bold; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 2px; }
    .btn-start { background: #0f0; color: #000; }
    .btn-stop { background: #e94560; color: #fff; }
    .btn-delete { background: #333; color: #fff; }
    .btn-read { background: #0f3460; color: #fff; }
    .registers { background: #0a0a15; padding: 10px; margin-top: 10px; border-radius: 4px; font-family: monospace; font-size: 11px; }
    .add-form { background: #16213e; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #0f3460; }
    .add-form h3 { margin-bottom: 15px; }
    .form-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: end; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-size: 12px; color: #aaa; margin-bottom: 4px; }
    .form-group input, .form-group select { padding: 8px; border: 1px solid #0f3460; background: #0a0a15; color: #fff; border-radius: 4px; }
    .hidden { display: none; }
    .records-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
    .records-table th, .records-table td { padding: 4px 8px; text-align: left; border-bottom: 1px solid #0f3460; }
    .records-table th { background: #0f3460; color: #fff; }
    .records-table tr:hover { background: #1a2a4e; }
    .value { color: #0f0; font-weight: bold; }
    .unit { color: #aaa; }
    .meter-info { background: #0a0a15; padding: 8px; border-radius: 4px; margin: 10px 0; font-size: 12px; }
    .meter-info span { margin-right: 15px; }
    .read-result { max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>M-Bus to Modbus TCP Converter</h1>

    <div class="add-form">
      <h3>Add New Loop</h3>
      <form id="addForm">
        <div class="form-row">
          <div class="form-group">
            <label>Loop ID</label>
            <input type="number" name="id" required style="width:80px">
          </div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" name="name" placeholder="Loop 1" style="width:120px">
          </div>
          <div class="form-group">
            <label>M-Bus Type</label>
            <select name="mbusType" id="mbusType">
              <option value="tcp">TCP</option>
              <option value="serial">Serial</option>
            </select>
          </div>
          <div class="form-group tcp-fields">
            <label>M-Bus Host</label>
            <input type="text" name="mbusHost" placeholder="192.168.1.100" style="width:130px">
          </div>
          <div class="form-group tcp-fields">
            <label>M-Bus Port</label>
            <input type="number" name="mbusPort" value="10001" style="width:80px">
          </div>
          <div class="form-group serial-fields hidden">
            <label>Serial Path</label>
            <input type="text" name="mbusPath" placeholder="/dev/ttyUSB0" style="width:120px">
          </div>
          <div class="form-group serial-fields hidden">
            <label>Baud Rate</label>
            <input type="number" name="baudRate" value="2400" style="width:80px">
          </div>
          <div class="form-group">
            <label>Modbus TCP Port</label>
            <input type="number" name="modbusPort" value="5021" required style="width:80px">
          </div>
          <div class="form-group">
            <label>M-Bus Addr</label>
            <input type="number" name="mbusAddress" value="1" style="width:60px" title="M-Bus device address (1-250)">
          </div>
          <div class="form-group">
            <label>Poll (ms)</label>
            <input type="number" name="pollInterval" value="60000" style="width:80px">
          </div>
          <button type="submit" class="btn btn-start">Add Loop</button>
        </div>
      </form>
    </div>

    <div class="grid" id="loopsGrid">
      <% if (loops.length === 0) { %>
        <div class="card">
          <p style="color:#666">No loops configured. Add one above.</p>
        </div>
      <% } %>
      <% loops.forEach(loop => { %>
        <div class="card" data-id="<%= loop.id %>">
          <h3><%= loop.name %> <span class="status <%= loop.status %>"><%= loop.status %></span></h3>
          <div class="port">Modbus TCP :<%= loop.modbusPort %></div>
          <div class="info">M-Bus: <%= loop.mbusType.toUpperCase() %> - <%= loop.mbusConnection %> (Addr: <%= loop.devices?.[0]?.address || '?' %>)</div>
          <div class="info">Last Poll: <%= loop.lastPoll ? new Date(loop.lastPoll).toLocaleString() : 'Never' %></div>
          <% if (loop.lastError) { %>
            <div class="info" style="color:#e94560">Error: <%= loop.lastError %></div>
          <% } %>

          <div style="margin-top:10px">
            <% if (loop.status !== 'running') { %>
              <button class="btn btn-start" onclick="startLoop(<%= loop.id %>)">Start</button>
            <% } else { %>
              <button class="btn btn-stop" onclick="stopLoop(<%= loop.id %>)">Stop</button>
            <% } %>
            <button class="btn btn-delete" onclick="deleteLoop(<%= loop.id %>)">Delete</button>
            <button class="btn btn-read" onclick="testRead(<%= loop.id %>)">Test Read</button>
            <button class="btn" style="background:#555" onclick="changeAddress(<%= loop.id %>)">Set Addr</button>
          </div>

          <% if (loop.lastData && loop.lastData.manufacturer) { %>
            <div class="meter-info">
              <span><b>ID:</b> <%= loop.lastData.id %></span>
              <span><b>Mfr:</b> <%= loop.lastData.manufacturer %></span>
              <span><b>Medium:</b> <%= loop.lastData.medium %></span>
              <span><b>Ver:</b> <%= loop.lastData.version %></span>
            </div>
          <% } %>

          <div class="registers">
            <b>Modbus Registers (FLOAT32, Big Endian):</b><br>
            <% if (loop.lastData && loop.lastData.records && loop.lastData.records.length > 0) { %>
              <table class="records-table">
                <tr><th>Reg</th><th>Value</th><th>Unit</th></tr>
                <% let regAddr = 0; loop.lastData.records.forEach(rec => { %>
                  <% if (typeof rec.value === 'number') { %>
                    <tr>
                      <td><%= regAddr %>-<%= regAddr+1 %></td>
                      <td class="value"><%= rec.value.toFixed(3) %></td>
                      <td class="unit"><%= rec.unit %></td>
                    </tr>
                    <% regAddr += 2; %>
                  <% } %>
                <% }); %>
              </table>
            <% } else { %>
              [<%= loop.registers.slice(0,10).join(', ') %>...]
            <% } %>
          </div>

          <div class="read-result" id="result-<%= loop.id %>" style="display:none"></div>
        </div>
      <% }) %>
    </div>
  </div>

  <script>
    document.getElementById('mbusType').addEventListener('change', function() {
      const isTcp = this.value === 'tcp';
      document.querySelectorAll('.tcp-fields').forEach(el => el.classList.toggle('hidden', !isTcp));
      document.querySelectorAll('.serial-fields').forEach(el => el.classList.toggle('hidden', isTcp));
    });

    document.getElementById('addForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(this));
      await fetch('/api/loops', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      location.reload();
    });

    async function startLoop(id) {
      await fetch(`/api/loops/${id}/start`, { method: 'POST' });
      location.reload();
    }

    async function stopLoop(id) {
      await fetch(`/api/loops/${id}/stop`, { method: 'POST' });
      location.reload();
    }

    async function deleteLoop(id) {
      if (confirm('Delete this loop?')) {
        await fetch(`/api/loops/${id}`, { method: 'DELETE' });
        location.reload();
      }
    }

    async function changeAddress(id) {
      const address = prompt('Enter M-Bus device address (1-250):', '25');
      if (!address) return;
      await fetch(`/api/loops/${id}/address`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ address: parseInt(address) })
      });
      alert('Address updated to ' + address + '. Restart loop to apply.');
      location.reload();
    }

    async function testRead(id) {
      const address = prompt('M-Bus device address (1-250):', '1');
      if (!address) return;
      const el = document.getElementById(`result-${id}`);
      el.style.display = 'block';
      el.innerHTML = '<i>Reading address ' + address + '...</i>';

      try {
        const res = await fetch(`/api/loops/${id}/read`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address: parseInt(address) })
        });

        if (!res.ok) {
          el.innerHTML = `<div style="color:#e94560">HTTP Error: ${res.status}</div>`;
          return;
        }

        const data = await res.json();
        console.log('Test read result:', data);

        if (data.error) {
          el.innerHTML = `<div style="color:#e94560">Error: ${data.error}</div>`;
        } else if (data.records && data.records.length > 0) {
          let html = `<div class="meter-info"><b>ID:</b> ${data.id || 'N/A'} | <b>Mfr:</b> ${data.manufacturer || 'N/A'} | <b>Medium:</b> ${data.medium || 'N/A'}</div>`;
          html += '<table class="records-table"><tr><th>#</th><th>Value</th><th>Unit</th><th>Raw</th></tr>';
          data.records.forEach((rec, i) => {
            const val = typeof rec.value === 'number' ? rec.value.toFixed(3) : rec.value;
            html += `<tr><td>${i}</td><td class="value">${val}</td><td class="unit">${rec.unit}</td><td>${rec.rawValue}</td></tr>`;
          });
          html += '</table>';
          el.innerHTML = html;
        } else if (data.raw) {
          el.innerHTML = `<div class="meter-info">Raw response (no records parsed)</div><pre style="font-size:10px;word-break:break-all">${data.raw}</pre>`;
        } else {
          el.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (err) {
        console.error('Test read error:', err);
        el.innerHTML = `<div style="color:#e94560">Fetch error: ${err.message}</div>`;
      }
    }

    // Manual refresh button instead of auto-refresh
    // Press F5 or click refresh to update status
  </script>
</body>
</html>
